/*
脚本引用 https://raw.githubusercontent.com/Maasea/sgmodule/master/Script/Bilibili/bilibili.helper.v2.js
*/
// Build: 2025/3/9 10:40:12
(()=>{var O=Object.defineProperty;var U=(r,e,t)=>e in r?O(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>(U(r,typeof e!="symbol"?e+"":e,t),t);var d=class{_times=new Map;name;isDebug;className;request;response;constructor(e,t,s){this.name=e??"",this.isDebug=s?.debug??!1,e&&this.debug(`${e} Start`),this.className=t??"",this.init()}static getInstance(e,t){let s="Surge";return typeof $loon<"u"?s="Loon":typeof $task<"u"&&(s="QuanX"),d.instances[s]||(d.instances[s]=d.classNames[s](e,s,t)),d.instances[s]}createProxy(e){return new Proxy(e,{get:this.getFn,set:this.setFn})}getFn(e,t,s){return e[t]}setFn(e,t,s,n){return e[t]=s,!0}getJSON(e,t={}){let s=this.getVal(e);return s?JSON.parse(s):t}setJSON(e,t){this.setVal(JSON.stringify(e),t)}msg(e=this.name,t="",s="",n){}debug(e){this.isDebug&&(typeof e=="object"&&(e=JSON.stringify(e)),console.log(e))}log(e){typeof e=="object"&&(e=JSON.stringify(e)),console.log(e)}timeStart(e){this._times.set(e,Date.now())}timeEnd(e){if(this._times.has(e)){let t=this._times.get(e)??0,s=Date.now()-t;this.debug(`${e}: ${s}ms`),this._times.delete(e)}else this.debug(`Timer with label ${e} does not exist.`)}exit(){$done({})}reject(){$done()}decodeParams(e){return e}},c=d;l(c,"instances",{}),l(c,"classNames",{QuanX:(e,t,s)=>new y(e,t,s),Surge:(e,t,s)=>new u(e,t,s),Loon:(e,t,s)=>new m(e,t,s)});var p=class extends c{getFn(e,t,s){let n=p.clientAdapter[t]||t;return super.getFn(e,n,s)}setFn(e,t,s,n){let i=p.clientAdapter[t]||t;return super.setFn(e,i,s,n)}init(){try{this.request=this.createProxy($request),this.response=this.createProxy($response)}catch(e){this.debug(e.toString())}}getVal(e){return $persistentStore.read(e)}setVal(e,t){$persistentStore.write(e,t)}msg(e=this.name,t="",s="",n){let i={};n&&(i={action:{"open-url":n}}),$notification.post(e,t,s,i)}async fetch(e){return await new Promise((t,s)=>{let{method:n,body:i,bodyBytes:o,...f}=e,b=o??i,$=b instanceof Uint8Array;$httpClient[n.toLowerCase()]({...f,body:b,"binary-mode":$},(B,g,S)=>{B&&s(B);let A=$?"bodyBytes":"body";t({status:g.status??g.statusCode,headers:g.headers,[A]:S})})})}done(e){let t=e.response??e;t.bodyBytes&&(t.body=t.bodyBytes,delete t.bodyBytes),$done(t)}decodeParams(e){return typeof $argument=="string"&&!$argument.includes("{{{")&&Object.assign(e,JSON.parse($argument)),e}},u=p;l(u,"clientAdapter",{bodyBytes:"body"});var a=class extends c{static transferBodyBytes(e,t){return e instanceof ArrayBuffer?t==="Uint8Array"?new Uint8Array(e):e:e instanceof Uint8Array&&t==="ArrayBuffer"?e.buffer.slice(e.byteOffset,e.byteLength+e.byteOffset):e}init(){try{this.request=this.createProxy($request),this.response=this.createProxy($response)}catch(e){this.debug(e.toString())}}getFn(e,t,s){let n=a.clientAdapter[t]||t,i=super.getFn(e,n,s);return t==="bodyBytes"&&(i=a.transferBodyBytes(i,"Uint8Array")),i}setFn(e,t,s,n){let i=a.clientAdapter[t]||t,o=s;return t==="bodyBytes"&&(o=a.transferBodyBytes(o,"Uint8Array")),super.setFn(e,i,o,n)}getVal(e){return $prefs.valueForKey(e)}setVal(e,t){$prefs.setValueForKey(e,t)}msg(e=this.name,t="",s="",n){$notify(e,t,s,{"open-url":n??""})}async fetch(e){return await new Promise(t=>{let s={url:"",method:"GET"};for(let[n,i]of Object.entries(e))n==="id"?s.sessionIndex=i:n==="bodyBytes"?s.bodyBytes=a.transferBodyBytes(i,"ArrayBuffer"):s[n]=i;e.bodyBytes&&delete s.body,$task.fetch(s).then(n=>{let i={status:200,headers:{}};for(let[o,f]of Object.entries(n))o==="sessionIndex"?i.id=f:o==="bodyBytes"?i.bodyBytes=a.transferBodyBytes(f,"Uint8Array"):o==="statusCode"?i.status=f:i[o]=f;t(i)})})}done(e){let t=e.response??e,s={};for(let[n,i]of Object.entries(t))n==="status"?s.status=`HTTP/1.1 ${i}`:n==="bodyBytes"?s.bodyBytes=a.transferBodyBytes(i,"ArrayBuffer"):s[n]=i;$done(s)}},y=a;l(y,"clientAdapter",{id:"sessionIndex",status:"statusCode"});var m=class extends u{decodeParams(e){if(typeof $argument<"u")for(let t of Object.keys(e)){let s=$argument?.[t];s!==void 0&&(e[t]=s)}return e}};var R=c.getInstance("Bilibili Helper",{debug:!1});function h(r){$done({body:JSON.stringify(r)})}function x(r){r.data.item=r.data.item.filter(e=>!e.linktype.endsWith("_ad")),h(r)}function w(r){let e=["account","event_list","preload","show"],t={max_time:0,min_interval:31536e3,pull_interval:31536e3},s={duration:0,enable_pre_download:!1,end_time:2209046399,begin_time:220896e4};if(r.data&&(e.forEach(n=>delete r.data[n]),Object.entries(t).forEach(([n,i])=>{r.data[n]&&(r.data[n]=i)}),r.data.list))for(let n of r.data.list)Object.assign(n,s);h(r)}function N(r){r.data.items=r.data.items.filter(e=>!/banner|cm/.test(e.card_type)),h(r)}try{let r=$request.url,e=$response.body;e||$done({}),e=JSON.parse(e);let t={search:x,"feed/index":N,splash:w};for(let s in t)if(r.includes(s)){t[s](e);break}}catch(r){console.log(r.toString())}finally{$done({})}})();